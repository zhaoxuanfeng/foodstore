<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>购物车</title>
    <link rel="stylesheet" href="/static/css/index.css">
    <link rel="stylesheet" type="text/css" href="/static/css/css.css" />
    <link rel="stylesheet" type="text/css" href="/static/js/jquery-easyui-1.5/themes/bootstrap/easyui.css" />
    <link rel="stylesheet" type="text/css" href="/static/js/jquery-easyui-1.5/themes/icon.css" />
    <script src="/static/js/jquery-3.3.1.js"></script>
</head>
<body>
<div id="trolley_layout" class="easyui-panel"  data-options="region:'east',expandMode:'float'"  style="width:100%;height:940px;border: none;"   >
    <form  id="tolley_from" >
        <table id="tolley_table" class="easyui-datagrid"  singleSelect="false" fitColumns="true" nowrap="false" striped="true"
               SelectOnCheck="true" CheckOnSelect="true" rownumbers="true"
               toolbar="#buy_div" fit="false" style="width:100%;height: 900px" pagination="true" pageSize="10" pageList="[25, 50, 150]" >
            <!-- title="购物车列表"   href="self/addTolleyData.action" -->
            <thead>
            <tr>
                <th field="select" align="center" checkbox="true" ></th>
                <th field="recipesName" title="食品名称" align="left"   width="0%"></th>
                <th field="recipesId" title="食品ID" align="left"   width="60%"></th>
                <th field="recipesPrice"  title="食品价格" align="left"  width="30%"></th>
                <th field="count"  title="数量" align="left"  width="0%"></th>
                <th field="orderId" title="订单ID" align="left"  width="0%"></th>
            </tr>
            </tr>
            </thead>
        </table>
    </form>
</div>
<div id="buy_div" >
    <input type="button" class="easyui-linkbutton" value="刷新购物车" onclick="refeshTolley()"/>
    <input class="easyui-linkbutton" form="tolley_from" type="button" value="确定购买" onclick="addOrder()" >
    <p>购物车总价为：</p><input type="text" id="sum_price" readonly="readonly" name="sumPrice" value="0">
</div>

</body>
<footer th:replace="footer::footer">
</footer>
<script type="text/javascript" th:inline="none">
    $(function () {
        loadTolleyData();
    });

    function loadTolleyData(){
        $("#tolley_table").datagrid( {
            url:'/self/tolleyData.action',
            height:'100%',
            striped: true,
            rownumbers:true,
            pagination: true,
            pageSize: 10,
            pageList: [10, 20, 50],
            border : false,
            showFooter : true,
            loadMsg:'数据加载中，请稍等...',
            columns:[[
                {field:'select',checkbox:true},
                {field:'recipesName',title:'食品名称',width:'60%',align:'right'},
                {field:'recipesId',title:'食品ID',width:'0%',align:'right'},
                {field:'recipesPrice',title:'食品价格',width:'30%',align:'right'},
                {field:'count',title:'数量',width:'30%',align:'right',formatter:function (value,row,index) {
                        if(row.count){
                            if(row.count > 0){
                                return row.count;
                            }
                        }
                        return 1;
                    }},
                {field:'orderId',title:'订单ID',width:'0%',align:'right'}
            ]],
            onBeforeLoad:function(param){
                // console.log(param);
            },
            onLoadSuccess: function (data){
                // console.log(data);
                var sumPrice = 0;
                $.each(data.rows,function (i,val) {
                    sumPrice = sumPrice +val.recipesPrice;
                });
                $("#sum_price").val(sumPrice);
            },
            onLoadError: function (){
                alert("数据加载失败！");
            }
        });
        /* $("#tolley_table").datagrid("loading");
         $("#tolley_table").datagrid("loadData",{total:0,rows:[]});
         $.get("self/tolleyData.action",$("#tolley_from").serialize(),function (pager) {
             console.log(pager);
             console.log(pager.rows);
             $("#tolley_table").datagrid("loadData",{'total':pager.total,rows:pager.rows,pageNumber:pager.pageNumber,pageSize:pager.pageSize});
             $("#tolley_table").datagrid("loaded");
         });*/
    }
</script>
<script type="text/javascript" th:inline="javascript">
    var userInfo = [[${session.userInfo}]];
    function addOrder() {

        $("#pageurl").siblings().remove();
        var sumPrice =  0;
        var rows = $('#tolley_table').datagrid("getChecked");
        // console.log(rows);



        var items = [];
        if(rows){
            $.each(rows,function (index,item) {
                item.userId = userInfo.userId;
                if(null == item.count){
                    item.count = 1;
                }
                sumPrice = sumPrice + item.recipesPrice * item.count;
                items.push(item);
            });
            $.get("/self/payDirect.action",{userOrderList:JSON.stringify(items),sumPrice:sumPrice.toString()},function (data) {
                // alert(data);
                // window.location= data;

               if(top != self){
                   // console.log($("#center_layout",parent.document));
                   $("#center_layout",parent.document).title = "订单信息确认";
                   $("#pageurl",parent.document).attr("src","/self/payDirectPage.action");
                   $("#pageurl",parent.document).show();
               }


            });


        }else {
            alert("请至少选择一项商品！");
        }

    }

    function refeshTolley() {
        loadTolleyData();
    }
</script>
</html>