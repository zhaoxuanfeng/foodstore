<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="header :: header">
</head>

<body style="margin:0px;">


<table id="dg" class="easyui-datagrid" title="财务管理 -- 存管扣款记录 " singleSelect="true" fitColumns="true" nowrap="false" striped="true"
       SelectOnCheck="true" CheckOnSelect="true" rownumbers="true" pagination="true" pageSize="50" pageList="[50, 100, 200]" toolbar="#tb" fit="true">
    <thead>
    <tr>
        <th field="select" align="center" checkbox="true">操作</th>
        <th field="chargeAccountRole" align="center" width="7%"formatter="showChargeAccountRole">扣款人角色</th>
        <th field="chargeAccountId" align="center" width="9%">扣款账户ID</th>
        <th field="chargeAccountNo" align="center" width="12%">扣款账户编号</th>
        <th field="amount" align="center" width="8%">扣款金额</th>
        <th field="chargeType" align="center" width="8%"  formatter="showChargeType">扣费方式</th>
        <th field="applyTime" align="center" width="10%" formatter="timeStamp2DateTime">扣款申请时间</th>
        <th field="aduitTime" align="center" width="10%" formatter="timeStamp2DateTime">扣款复核时间</th>
        <th field="applyUserId" align="center" width="9%">扣款申请人</th>
        <th field="aduitUserId" align="center" width="9%">扣款复核人</th>
        <th field="groupType" align="center" width="9%" formatter="showGruopType">费用所属部门</th>
        <th field="bizStatus" align="center" width="8%" formatter="showBizStatus">状态</th>
    </tr>
    </thead>
</table>
<!-- 显示搜索框搜索条件 -->
<div id="tb" style="padding:2px 5px;">
    <form id="formSearch">
        <input type="hidden" name="hiddenSelectedIds" id="hiddenSelectedIds" />
        <div width="100%" style="margin:4px">
            <input type="hidden" name="pageSize" id="pageSize" value="50" />
            <input type="hidden" name="pageNumber" id="pageNumber" value="1" />
            扣金额：<input type="text" id="searchAmount" name="searchAmount" class="easyui-textbox" maxlength="20" style="width:100px"/>&nbsp;&nbsp;&nbsp;
            扣款账户ID：<input type="text" id="searchChargeAccountId" name="searchChargeAccountId" class="easyui-textbox" maxlength="20" style="width:150px"/>&nbsp;&nbsp;&nbsp;
            扣款人角色：<select class="easyui-combobox" id="searchChargeAccountRole" name="searchChargeAccountRole" panelHeight="auto" editable="false" style="width:120px">
            <option value="" selected>全部</option>
            <option value="200,200">个人投资人</option>
            <option value="200,300">企业投资人</option>
            <option value="300,200">个人借款人</option>
            <option value="300,300">企业借款人</option>
            <option value="400,300">资产方担保户</option>
            <option value="500,300">商户</option>
        </select>&nbsp;&nbsp;&nbsp;
            扣款时间：<input class="easyui-datebox" id="startTime" name="startTime" type="text" editable="false"> --
            <input class="easyui-datebox" id="endTime" name="endTime" type="text" editable="false">&nbsp;&nbsp;&nbsp;
            状态：<select class="easyui-combobox" id="bizStatus" name="bizStatus" panelHeight="auto" editable="false" style="width:140px">
            <option value="" selected>全部</option>
            <option value="100">待审核</option>
            <option value="150">审核拒绝</option>
            <option value="200">审核通过</option>
            <option value="250">已调用存管</option>
            <option value="300">存管调用失败</option>
            <option value="350">存管处理中</option>
            <option value="400">存管处理失败</option>
            <option value="450">存管处理成功</option>
            <option value="500">创建内账订单</option>
            <option value="550">创建内账订单失败</option>
            <option value="600">创建内账订单成功</option>
            <option value="650">完成内账订单</option>
            <option value="700">完成内账订单失败</option>
            <option value="750">完成内账订单成功</option>
        </select>&nbsp;&nbsp;&nbsp;
            <a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick="btnSearch()">查询</a>&nbsp;&nbsp;&nbsp;
        </div>
        <div>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <a href="#" class="easyui-linkbutton" iconCls="icon-add" onclick="btnAddPlatFormChargeRecord()">新增</a>&nbsp;&nbsp;&nbsp;&nbsp;
            <a href="#" class="easyui-linkbutton" iconCls="icon-edit" onclick="btnMarketTransferAuit()">审核</a>&nbsp;&nbsp;&nbsp;&nbsp;
            <a href="#" class="easyui-linkbutton" iconCls="icon-edit" onclick="btnGetPwdArdess()">获取验密地址</a>
        </div>
    </form>
</div>

<!--点击新增按钮，显示新增的弹窗-->
<form id="platformChargeRecordDetailForm" method="post">
    <div id="dgPlatFormChargeRecordDetail" class="easyui-dialog" title="新增" width="1060px" height="395px" closed="true" buttons="#dlgPlatFormChargeRecordDetail-buttons" style="padding:10px" modal="true">
        <table align="center" width="90%" cellpadding="2" cellspacing="2">
            <tr>
                <td>扣款人角色:
                    <select class="easyui-combobox" id="chargeAccountRole"  name="chargeAccountRole"  panelHeight="auto" editable="false" maxlength="18" style="width:120px">
                        <option value="" selected>全部</option>
                        <option value="200,200">个人投资人</option>
                        <option value="200,300">企业投资人</option>
                        <option value="300,200">个人借款人</option>
                        <option value="300,300">企业借款人</option>
                        <option value="400,300">资产方但保户</option>
                        <option value="500,300">商户</option>
                    </select>
                </td>
                <td>扣款账户ID:<input type="text" id="chargeAccountId" name="chargeAccountId" class="easyui-textbox" maxlength="20" style="width:150px"/>&nbsp;&nbsp;</td>
                <td>扣款账户编号:<input type="text" id="chargeAccountNo" name="chargeAccountNo" class="easyui-textbox" maxlength="20" style="width:150px"/>&nbsp;&nbsp;</td>
                <td>扣款账户余额:<input type="text" id="accountBalance" name="accountBalance" class="easyui-textbox" maxlength="20" style="width:150px"/>&nbsp;&nbsp;</td>
            </tr><tr><td></td></tr><tr><td></td></tr>
            <tr>
                <td>扣款金额:
                    <input type="text" id="amount" name="amount" class="easyui-numberbox  easyui-validatebox"   precision="2" missingMessage="请输入转账金额"  data-options="validType:'intOrFloat'" validType="length[1,20]" maxlength="20" style="width:130px"></td>&nbsp;&nbsp;
                <td>扣费方式:<span class="radioSpan">
                         <input type="radio" id="open" name="chargeType" value="100" checked="checked">验密扣费</input>
                    <input type="radio"  name="chargeType" value="200">免密扣费</input>
                     </span>
                </td>
                <td>
                    &nbsp;&nbsp;&nbsp;入账账户:
                    <select class="easyui-combobox" id="platformAccountRole"  name="platformAccountRole"  panelHeight="auto" editable="false" maxlength="18" style="width:162px">
                        <option value="" selected></option>
                        <option value="100">营销账户</option>
                        <option value="110">收入账户</option>
                    </select>
                </td>
            </tr><tr><td></td></tr><tr><td></td></tr>
            <tr>
                <td colspan="2">扣费说明:<input type="text" id="showContent" name="showContent" class="easyui-textbox" maxlength="10" style="width:360px"/>&nbsp;&nbsp;</td>
                <td colspan="1">费用所属部门:
                    <select class="easyui-combobox" id="groupType"  name="groupType"  panelHeight="auto" editable="false" maxlength="18" style="width:150px">
                        <option value="" selected></option>
                        <option value="100">市场部</option>
                        <option value="110">运营部</option>
                        <option value="120">战略合作部</option>
                        <option value="130">其他</option>
                    </select>
                </td>
            </tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
            <tr>
                <td  colspan="3">申请备注(字符限50)
                    <input  class="easyui-textbox" type="text" id="remark" name="remark" multiline="true"  style="height:100px; width:410px "  data-options="missingMessage:'备注'"/>
                </td>
            </tr>
            <tr><td><input type="hidden" name="hiddenAccountType" id="hiddenAccountType" class="easyui-textbox"/></td></tr>
            <tr><td><input type="hidden" name="hiddenAccountRole" id="hiddenAccountRole" class="easyui-textbox"/></td></tr>
        </table>
    </div>
</form>

<div id="dlgPlatFormChargeRecordDetail-buttons">
    <div align="center">
        <a href="javascript:void(0)"  class="easyui-linkbutton"  onclick="btnsave()" iconcls="icon-save">保存</a>
        <a href="javascript:void(0)"  class="easyui-linkbutton"  onclick="cancel()" iconcls="icon-cancel">取消</a>
    </div>
</div>

<!--点击审核按钮，显示审核的弹窗-->
<div id="dgMarketTransRecordAudit" class="easyui-dialog" title="审核" width="1000px" height="500px" closed="true" buttons="#dlgMarketTransRecordAudit-buttons" style="padding:10px" modal="true">
    <form id="marketTransRecordAuitForm" method="post">
        <table align="center" width="95%" cellpadding="2" cellspacing="2">
            <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
            <tr>
                <td>扣款人角色:</td>
                <td>
                    <select class="easyui-combobox" id="searchReceiveAccountRoleAudit" name="searchReceiveAccountRoleAudit"  panelHeight="auto" editable="false" maxlength="18" style="width:120px">
                        <!--借款人分为个人借款人和企业借款人-->
                        <option value="" selected></option>
                        <option value="200,300">个人借款人</option>
                        <option value="300,300">企业借款人</option>
                        <option value="200,200">个人投资人</option>
                        <option value="300,200">企业投资人</option>
                        <option value="500">商户</option>
                        <option value="400">资产方担保户</option>
                    </select>
                </td>
                <td>扣款账户ID:</td>
                <td><input type="text" id="searchAccountIdAudit" name="searchAccountId" class="easyui-textbox" maxlength="20" editable="false" style="width:150px"/>&nbsp;&nbsp;</td>
                <td>扣款账户编号:</td>
                <td><input type="text" id="searchAccountNoAudit" name="searchAccountNo" class="easyui-textbox" maxlength="20" editable="false" style="width:120px"/>&nbsp;&nbsp;</td>
                <td>扣款账户余额:</td>
                <td><input type="text" id="withHoldAmountAudit" name="withHoldAmountAudit" class="easyui-textbox" maxlength="20" editable="false" style="width:120px"/>&nbsp;&nbsp;</td>
            </tr><tr><td></td></tr><tr><td></td></tr>
            <tr>
                <td>扣款金额:</td>
                <td><input type="text" id="amountAudit" name="amountAudit" class="easyui-textbox  easyui-validatebox" missingMessage="请输入转账金额"  data-options="validType:'intOrFloat'" validType="length[1,20]" maxlength="20" editable="false" style="width:120px"></td>
                <td>扣费方式:</td>
                <td>
                    <label><input id="verificationCode" name="transferType" type="radio" value="100" />验密扣费 </label>
                    <label><input id="unVerificationCode" name="transferType" type="radio" value="200" />免密扣费</label>
                </td>
                <td>入账账户:</td>
                <td>
                    <select class="easyui-combobox" id="incomeTypeAudit"  name="incomeTypeAudit"  panelHeight="auto" editable="false" maxlength="18" style="width:120px">
                        <option value="" selected></option>
                        <option value="100">营销账户</option>
                        <option value="110">收入账户</option>
                    </select>
                </td>
            </tr><tr><td></td></tr><tr><td></td></tr>
            <tr>
                <td>扣费说明:</td>
                <td colspan="3"><input type="text" id="withHoldRemarkAudit" name="withHoldRemarkAudit" editable="false" class="easyui-textbox" maxlength="20" style="width:360px"/>&nbsp;&nbsp;</td>
                <td>费用所属部门:</td>
                <td colspan="2">
                    <select class="easyui-combobox" id="groupTypeAudit"  name="groupTypeAudit"  panelHeight="auto" editable="false" maxlength="18" style="width:150px">
                        <option value="" selected></option>
                        <option value="100">市场部</option>
                        <option value="110">运营部</option>
                        <option value="120">战略合作部</option>
                        <option value="130">其他</option>
                    </select>
                </td>
            </tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
            <tr>
                <td>申请备注<br>(字符限50)</td>
                <td  colspan="5">
                    <input id="applyRemark" name="applyRemark" class="easyui-textbox" required="true" labelPosition="top" multiline="true" validateOnCreate="false" validateOnBlur="true" editable="false" style="height:90px; width:450px">
                </td>
            </tr>
            <tr>
                <td>审核备注<br>(字符限50)</td>
                <td  colspan="5">
                    <input id="aduitRemark" name="aduitRemark" class="easyui-textbox" required="true" data-options="validType:['length[1,50]']" missingMessage="该输入项为必输项,请输入审核备注" labelPosition="top" multiline="true" validateOnCreate="false" validateOnBlur="true" style="height:90px; width:450px">
                </td>
            </tr>
        </table>
    </form>
</div>
<div id="dlgMarketTransRecordAudit-buttons">
    <div align="center">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnAduitPass()" iconcls="icon-save">审核通过</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnAduitDeny()" iconcls="icon-save">审核不通过</a>
    </div>
</div>



<!--获取验密地址-->
<div id="dlgPlatformPwdAddressDetail" class="easyui-dialog" title="重新获取验密地址" width="1000px" height="500px" closed="true" buttons="#dlgPlatformPwdAddressDetail-buttons" style="padding:10px" modal="true">
    <form id="platformPwdAddressDetail" method="post">
        <table align="center" width="95%" cellpadding="2" cellspacing="2">
            <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
            <tr>
                <td>扣款人角色:</td>
                <td>
                    <select class="easyui-combobox" id="searchReceiveAccountRole" name="searchReceiveAccountRole"  panelHeight="auto" editable="false" maxlength="18" style="width:120px">
                        <!--借款人分为个人借款人和企业借款人-->
                        <option value="" selected></option>
                        <option value="200,300">个人借款人</option>
                        <option value="300,300">企业借款人</option>
                        <option value="200,200">个人投资人</option>
                        <option value="300,200">企业投资人</option>
                        <option value="500">商户</option>
                        <option value="400">资产方担保户</option>
                    </select>
                </td>
                <td>扣款账户ID:</td>
                <td><input type="text" id="searchAccountId" name="searchAccountId" class="easyui-textbox" maxlength="20" editable="false" style="width:150px"/>&nbsp;&nbsp;</td>
                <td>扣款账户编号:</td>
                <td><input type="text" id="searchAccountNo" name="searchAccountNo" class="easyui-textbox" maxlength="20" editable="false" style="width:120px"/>&nbsp;&nbsp;</td>
                <td>扣款账户余额:</td>
                <td><input type="text" id="withHoldAmount" name="withHoldAmount" class="easyui-textbox" editable="false" maxlength="20" style="width:120px"/>&nbsp;&nbsp;</td>
            </tr><tr><td></td></tr><tr><td></td></tr>
            <tr>
                <td>扣款金额:</td>
                <td><input type="text" id="amountSum" name="amountSum" class="easyui-textbox  easyui-validatebox" missingMessage="请输入转账金额"  data-options="validType:'intOrFloat'" validType="length[1,20]" maxlength="20" editable="false" style="width:120px"></td>
                <td>扣费方式:</td>
                <td>
                    <label><input id="verificationCodeVerification" name="verificationCodeVerification" type="radio" value="100" />验密扣费 </label>
                    <label><input id="unVerificationCodeVerification" name="verificationCodeVerification" type="radio" value="200" />免密扣费</label>
                </td>
                <td>入账账户:</td>
                <td>
                    <select class="easyui-combobox" id="incomeType"  name="incomeType"  panelHeight="auto" editable="false" maxlength="18" style="width:120px">
                        <option value="" selected></option>
                        <option value="100">营销账户</option>
                        <option value="110">收入账户</option>
                    </select>
                </td>
            </tr><tr><td></td></tr><tr><td></td></tr>
            <tr>
                <td>扣费说明:</td>
                <td colspan="3"><input type="text" id="withHoldRemark" name="withHoldRemark" class="easyui-textbox" editable="false" maxlength="20" style="width:360px"/>&nbsp;&nbsp;</td>
                <td>费用所属部门:</td>
                <td colspan="2">
                    <select class="easyui-combobox" id="groupTypeVerification"  name="groupTypeVerification"  panelHeight="auto" editable="false" maxlength="18" style="width:120px">
                        <option value="" selected></option>
                        <option value="100">市场部</option>
                        <option value="110">运营部</option>
                        <option value="120">战略合作部</option>
                        <option value="130">其他</option>
                    </select>
                </td>
            </tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
            <tr>
                <td>申请备注<br>(字符限50)</td>
                <td  colspan="5">
                    <input id="applyRemarkVerification" name="applyRemarkVerification" class="easyui-textbox" required="true" labelPosition="top" multiline="true" validateOnCreate="false" validateOnBlur="true" editable="false" style="height:90px; width:500px">
                </td>
            </tr>
            <tr>
                <td>审核备注<br>(字符限50)</td>
                <td  colspan="5">
                    <input id="aduitRemarkVerification" name="aduitRemarkVerification" class="easyui-textbox" required="true" editable="false" labelPosition="top" multiline="true" validateOnCreate="false" validateOnBlur="true" style="height:90px; width:500px">
                </td>
            </tr>
            <tr>
               <td colspan="5"><a href="javascript:void(0)" style="margin-left: 300px" class="easyui-linkbutton" onclick="btnGetPwdAdress()" iconcls="icon-save">获取验证地址</a></td>
            </tr>
            <tr>
                <td>验证地址</td>
                <td  colspan="5">
                    <input type="text" id="checkPwdAddress" name="checkPwdAddress" class="easyui-textbox" required="true" editable="false" maxlength="100" style="height:45px;width:500px"/>&nbsp;&nbsp;</td>
                </td>
            </tr>
        </table>
    </form>
</div>

<input type="hidden" name="platformChargeRecordId" id="platformChargeRecordId" />

</body>

<footer th:replace="footer :: footer"></footer>

<script type="text/javascript">
    $(function(){
        $("#dg").datagrid({
            onClickRow: function (index, row) {
                $("#platformChargeRecordId").val(row.platformChargeRecordId);
            },
            onCheck: function (index, row) {
                $("#platformChargeRecordId").val(row.platformChargeRecordId);
                pushSelectedIds();
            },
            onUncheck: function (index, row) {
                pushSelectedIds();
            },
            onSelect: function (index, row) {
                pushSelectedIds();
            },
            onUnselect: function (index, row) {
                pushSelectedIds();
            },
            onSelectAll: function (rows) {
                pushSelectedIds();
            },
            onUnselectAll: function (rows) {
                pushSelectedIds();
            },
            onRefresh: function(pageNumber, pageSize) {
                datagridBind();
            }
        });


        //经与宋杰讨论，创建时间默认为当天
        $("#startTime").datebox("setValue", currNDate(0));//默认时间为当天
        $("#endTime").datebox("setValue", currNDate(0));//默认时间为当天
        onMouse();
        searchAccountBalance();

        //翻页控件，已支持分页
        $("#dg").datagrid().datagrid("getPager").pagination({
            //改变pageSize会执行 onChangePageSize，onSelectPage
            //点上一页或下一页只会执行 onSelectPage
            //刷新会执行 onSelectPage，onRefresh。所以删掉了onRefresh
            onChangePageSize: function(pageSize) {
                $("#pageSize").val(pageSize);
            },
            onSelectPage: function(pageNumber, pageSize) {
                $("#pageSize").val(pageSize);
                $("#pageNumber").val(pageNumber);
                datagridBind();
            },
            beforePageText: '第',
            afterPageText: '共{pages}页',
            displayMsg: '显示{from}到{to}条记录,共{total}条记录&nbsp;&nbsp;&nbsp;&nbsp;'//已支持分页，重新调整显示文字
        });

        //隐藏表头选框
        $("#dg").parent().find("div.datagrid-header-check").children("input[type='checkbox']").eq(0).attr("style", "display:none;");
    });


    //鼠标焦点事件，鼠标在离开input框时，会自动触发，补全accountNo
    //chargeAccountId扣款账户Id
    function onMouse() {
        $("input",$("#chargeAccountId").next("span")).blur(function(){
            var chargeAccountId = $("#chargeAccountId").val();
            $.ajax({
                type : "get",
                url : "getMarketTransferByAccountId.htm",
                async : false,
                data :{accountId:chargeAccountId},
                dataType : "json",
                success : function(data){
                    if(data.length > 0){
                        var jsonString = JSON.stringify(data);
                        $("#chargeAccountNo").textbox('setValue',JSON.parse(jsonString)[0].accountNo);
                        //同时设置隐藏域收款角色，添加操作做数据校验
                        $("#hiddenAccountRole").textbox('setValue',JSON.parse(jsonString)[0].accountRole);
                        $("#hiddenAccountType").textbox('setValue',JSON.parse(jsonString)[0].accountType);
                    }
                }
            });
        });

    }

    //根据accountId找到对应科目subjectId下的余额
    function searchAccountBalance(){
        $("input",$("#chargeAccountId").next("span")).blur(function(){
            var chargeAccountId = $("#chargeAccountId").val();
            if(chargeAccountId !=""){
                $.ajax({
                    type : "get",
                    url : "financeList.htm",
                    async : false,
                    data :{searchAccountId:chargeAccountId},
                    dataType : "json",
                    success : function(pager){

                        if(pager.pageData!=null && pager.pageData !=''){
                            //与宋杰确认从账户的其他应付款-可用余额查询扣款账户余额
                            var isNotHave = false;
                            for(var i = 0; i < pager.pageData.length; i++) {
                                if (pager.pageData[i].subjectId == "224101") {
                                    isNotHave = true;
                                    var balanceUse = pager.pageData[i].balanceUse;
                                    $("#accountBalance").textbox('setValue',balanceUse);
                                }
                            }if(!isNotHave){
                                $.messager.alert("提示", "该账户不存在其他应付款-可用余额子科目", "info");
                                $('#dgPlatFormChargeRecordDetail').dialog("close").window("center");
                                return ;
                            }
                        }else if(pager.pageData.length ==0){
                            $("#accountBalance").textbox('setValue',0);
                        }
                    }
                });
            }else{
                $.messager.alert("提示", "扣款账户ID不能为空,请填写完整", "info");
                return;
            }
        });
    }


    function datagridBind() {
        $("#dg").datagrid("loading");
        $.post("platformChargeRecordList.htm", $("#formSearch").serialize(), function(pager){
            $("#dg").datagrid("loadData", {"total":pager.total, rows:pager.pageData});
            $("#dg").datagrid("loaded");
        });
    }

    //获取n天前 yyyy-MM-dd
    function currNDate(n) {
        var date = new Date();//获取当前时间
        date.setDate(date.getDate() - n);//设置n天前
        var currTime = dateTimeFormat(date);
        return currTime.substring(0, 10);
    }

    //将选中的id放入selectedIds
    function pushSelectedIds() {
        var ids = [];
        var selectedRows = $('#dg').datagrid('getSelections');
        for(var i=0; i<selectedRows.length; i++){
            ids.push(selectedRows[i].id);
        }
        $("#hiddenSelectedIds").val(ids);
    }

    function btnSearch() {
        datagridBind();
    }

    //点击取消的时间清空所有的数据
    function cancel() {
        $('#chargeAccountNo').textbox('disable');
        $("#chargeAccountRole").combobox("setValue","");
        $("#chargeAccountId").textbox("setValue","");
        $("#chargeAccountNo").textbox("setValue","");
        $("#amount").textbox("setValue","");
        $("#platformAccountRole").combobox("setValue","");
        $("#showContent").textbox("setValue","");
        $("#groupType").combobox("setValue","");
        $("#remark").textbox("setValue","");
        $('#dgPlatFormChargeRecordDetail').dialog("close");
    }

    //添加操作
    function btnAddPlatFormChargeRecord() {
        $("#chargeAccountRole").combobox("setValue","");
        $("#chargeAccountId").textbox("setValue","");
        $('#chargeAccountNo').textbox('disable');
        $("#chargeAccountNo").textbox("setValue","");

        $('#accountBalance').textbox('disable');
        $("#accountBalance").textbox("setValue","");

        $("#amount").textbox("setValue","");
        var chargeType = $('input:radio[name="chargeType"]:checked').val().trim();
        if(chargeType !="100"){
            $("#open").prop("checked",true)
        }
        $("#platformAccountRole").combobox("setValue","");
        $("#showContent").textbox("setValue","");
        $("#groupType").combobox("setValue","");
        $("#remark").textbox("setValue","");

        $("#platformChargeRecordDetailForm").form('clear');                                           //每次新增之前，清空原数据
        $('#dgPlatFormChargeRecordDetail').dialog("open").window("center");
    }

    function btnsave() {
        //如果检测出accountId和角色不符合，就自动刷新，重新补全accountNo
        onMouse();
        var chargeAccountRole = $("#chargeAccountRole").combobox('getValue').trim();          //扣款人角色
        var chargeAccountId = $("#chargeAccountId").val().trim();                             //扣款账户ID
        var chargeAccountNo = $("#chargeAccountNo").val().trim();                             //扣款账户编号
        var accountBalance = $("#accountBalance").val();                                      //扣款账户余额
        var amount = $("#amount").val().trim();                                               //扣款金额
        var chargeType = $('input:radio[name="chargeType"]:checked').val();                   //扣费方式
        var platformAccountRole = $("#platformAccountRole").combobox("getValue");             //入账账户
        var showContent = $("#showContent").val();                                            //扣费说明
        var groupType = $("#groupType").combobox('getValue').trim();                          //费用所属部门
        var remark = $("#remark").val().trim();                                               //申请备注

        var hiddenAccountType = $("#hiddenAccountType").val().trim();
        var hiddenAccountRole = $("#hiddenAccountRole").val().trim();


        //数据校验
        if(chargeAccountRole =="" || chargeAccountRole == undefined){
            $.messager.alert("提示", "扣款人角色不能为空,请填写完整", "info");
            return;
        }else if(chargeAccountId ==""){
            $.messager.alert("提示", "扣款账户ID不能为空,请填写完整", "info");
            return;
        }else if(chargeAccountNo ==""){
            $.messager.alert("提示", "扣款账户编号不能为空,请填写完整", "info");
            return;
        }else if(accountBalance ==""){
            $.messager.alert("提示", "扣款账户余额不能为空,请填写完整", "info");
            return;
        }else if(amount == ""){
            $.messager.alert("提示", "扣账金额不能为空,请重新填写", "info");
            return;
        }else if(parseFloat(amount)<=0){
            $.messager.alert("提示", "扣账金额必须大于0,请重新填写", "info");
            return;
        }else if(parseFloat(amount)>100 && chargeType !=100){
            $.messager.alert("提示", "免密扣费扣账金额必须小于等于100元,请重新填写", "info");
            return;
        }else if(parseFloat(amount) > parseFloat(accountBalance)){
            $.messager.alert("提示", "扣账金额不能大于扣款账户余额,请重新填写", "info");
            return;
        }else if(chargeType =="" || chargeType == undefined){
            $.messager.alert("提示", "扣费方式不能为空,请填写完整", "info");
            return;
        }else if(platformAccountRole =="" || platformAccountRole == undefined){
            $.messager.alert("提示", "入账账户不能为空,请填写完整", "info");
            return;
        }else if(showContent !="" && showContent.length>10){
            $.messager.alert("提示", "扣费说明不能超过10个字，请重新填写", "info");
            return;
        }else if(groupType ==""){
            $.messager.alert("提示","费用所属部门不能为空","info");
            return;
        }else if(remark == ""){
            $.messager.alert("提示", "备注不能为空,请重新填写完整", "info");
            return;
        }else if(remark.length > 50){
            $.messager.alert("提示", "备注不能超过50个字,请重新填写完整", "info");
            return;
        }

        var newChargeAccountRole = hiddenAccountRole+","+ hiddenAccountType;
        //个人借款人(300,200) 企业借款人(300,300)
        //投资人都是个人(200,200) 为了以后的扩展 增加企业投资人(200,300)
        //商户和担保户都是企业(500,300) (300,300)
        if(chargeAccountRole.split(",")[0] == "300"){
            if(chargeAccountRole != newChargeAccountRole){
                $.messager.alert("提示", "收款人角色和收款人账户ID不符", "info");
                $("#chargeAccountRole").combobox("setValue","");
                $("#chargeAccountId").textbox("setValue","");
                $("#chargeAccountNo").textbox("setValue","");
                $("#accountBalance").textbox("setValue","");
                return;
            }
        }else if(chargeAccountRole.split(",")[0] == "200"){
            if(chargeAccountRole != newChargeAccountRole) {
                $.messager.alert("提示", "收款人角色和收款人账户ID不符", "info");
                $("#chargeAccountRole").combobox("setValue", "");
                $("#chargeAccountId").textbox("setValue", "");
                $("#chargeAccountNo").textbox("setValue", "");
                $("#accountBalance").textbox("setValue", "");
                return;
            }
        }else if(chargeAccountRole.split(",")[0] == "400"){
            if(chargeAccountRole != newChargeAccountRole){
                $.messager.alert("提示", "收款人角色和收款人账户ID不符", "info");
                $("#chargeAccountRole").combobox("setValue","");
                $("#chargeAccountId").textbox("setValue","");
                $("#chargeAccountNo").textbox("setValue","");
                $("#accountBalance").textbox("setValue","");
                return;
            }else {
                var chargeAccountRole = chargeAccountRole.toString().split(",")[0];
            }
        }else if(chargeAccountRole.split(",")[0] == "500"){
            if(chargeAccountRole != newChargeAccountRole){
                $.messager.alert("提示", "收款人角色和收款人账户ID不符", "info");
                $("#chargeAccountRole").combobox("setValue","");
                $("#chargeAccountId").textbox("setValue","");
                $("#chargeAccountNo").textbox("setValue","");
                $("#accountBalance").textbox("setValue","");
                return;
            }else{
                var chargeAccountRole = chargeAccountRole.toString().split(",")[0];
            }
        }



        //提交参数
        $.post("platformChargeRecordAdd.htm", {
            chargeAccountId: chargeAccountId,
            chargeAccountNo: chargeAccountNo,
            chargeAccountRole: chargeAccountRole,
            chargeAccountType: hiddenAccountType,
            amount: amount,
            chargeType: chargeType,
            platformAccountRole: platformAccountRole,
            showContent:showContent,
            groupType:groupType,
            remark:remark
        }, function (data) {
            if (data.status) {
                $.messager.alert("信息", "添加成功！", "info", function () {
                    $('#dgPlatFormChargeRecordDetail').dialog("close");
                    datagridBind();
                });
            } else {
                var message = " 添加失败";
                if (data.message != null) {
                    message = data.message;
                    datagridBind();
                }
                $.messager.alert("信息", message, "error");
            }
        }, "json");
    }

    //审核--数据回显
    function  btnMarketTransferAuit() {
        //将单选框的按钮失效
        gel("verificationCode").disabled = true;
        gel("unVerificationCode").disabled = true;
        $('#searchReceiveAccountRoleAudit').combobox('disable');
        $('#groupTypeAudit').combobox('disable');
        $('#incomeTypeAudit').combobox('disable');
        $('#groupTypeVerification').combobox('disable');
        //首先在打开弹窗时进行弹窗中信息的初始化
        $("#searchReceiveAccountRoleAudit").combobox('setValue', "");
        $("#searchAccountIdAudit").textbox('setValue', "");
        $("#searchAccountNoAudit").textbox('setValue', "");
        $("#withHoldRemarkAudit").textbox('setValue', "");
        $("#amountAudit").textbox('setValue', "");
        $("#applyContent").textbox('setValue', "");
        // 获取单行的值，进行数据回显
        var row = $('#dg').datagrid('getSelected');
        if (row != null) {
            var aduitRemark = $("#aduitRemark").textbox("getValue");
            //扣款人角色
            var chargeAccountRole = row.chargeAccountRole;
            //扣款账户ID
            var chargeAccountId = row.chargeAccountId;
            //扣款账户编号
            var chargeAccountNo = row.chargeAccountNo;
            //扣款账户余额
            //与宋杰确认从账户的其他应付款-可用余额查询扣款账户余额
            var isNotHave = false;
            //查询扣款人账户的其他应付款-可用余额
            $.get("financeList.htm", {searchAccountId:chargeAccountId}, function(pager){
                if(pager.pageData != null && pager.pageData != ''){
                    for(var i = 0; i < pager.pageData.length; i++) {
                        if (pager.pageData[i].subjectId == "224101") {
                            isNotHave = true;
                            var withHoldAmountAudit = decimalFormat(pager.pageData[i].balanceUse);
                            //扣账金额
                            var amount = row.amount;
                            //扣费方式
                            var chargeType = row.chargeType;
                            //入账账户
                            var platformAccountId = row.platformAccountId;
                            //费用所属部门
                            var groupType = row.groupType;
                            //申请备注
                            var applyContent = row.applyContent;
                            //扣费说明
                            var withHoldRemarkAudit = row.showContent;
                            var platformAccountType = row.platformAccountType;
                            var chargeAccountType = row.chargeAccountType;
                            if(row.bizStatus == "100") {
                                if (chargeAccountRole == "300") {
                                    var searchReceiveAccountRoleAudit = chargeAccountType + "," + chargeAccountRole;
                                    $("#searchReceiveAccountRoleAudit").combobox('setValue', searchReceiveAccountRoleAudit);
                                } else if(chargeAccountRole == "200") {
                                    var searchReceiveAccountRoleAudit = chargeAccountType + "," + chargeAccountRole;
                                    $("#searchReceiveAccountRoleAudit").combobox('setValue', searchReceiveAccountRoleAudit);
                                } else{
                                    var searchReceiveAccountRoleAudit = chargeAccountRole;
                                    $("#searchReceiveAccountRoleAudit").combobox('setValue', searchReceiveAccountRoleAudit);
                                }
                                $("#searchAccountIdAudit").textbox('setValue', chargeAccountId);
                                $("#searchAccountNoAudit").textbox('setValue', chargeAccountNo);
                                $("#withHoldAmountAudit").textbox('setValue', withHoldAmountAudit);
                                $("#amountAudit").textbox('setValue', amount);
                                $("#incomeTypeAudit").combobox('setValue', row.platformAccountRole);
                                $("#groupTypeAudit").combobox('setValue', groupType);
                                $("#applyRemark").textbox('setValue', applyContent);
                                $("#withHoldRemarkAudit").textbox('setValue', withHoldRemarkAudit);
                                if ($("#aduitRemark").textbox('getValue') != null && $("#aduitRemark").textbox('getValue') != "") {
                                    $("#aduitRemark").textbox('setValue', "");
                                }
                                var chargeType = row.chargeType;
                                //打开审核弹窗设置单选选中内容
                                if (chargeType == "100") {
                                    gel("verificationCode").checked = true;
                                } else if (chargeType == "200") {
                                    gel("unVerificationCode").checked = true;
                                } else {
                                    $.messager.alert("提示", "操作错误,请重新操作！", "info");
                                    return;
                                }
                                $('#dgMarketTransRecordAudit').dialog("open").window("center");
                            }else{
                                $.messager.alert("提示", "请选择待审核的项目！", "info");
                                return ;
                            }
                        }
                    }
                }

            },"json");
            if(isNotHave){
                $.messager.alert("提示", "改账户不存在其他应付款-可用余额子账户", "info");
                return ;
            }
        }else{
            $.messager.alert("提示", "请选择需要操作的项目！", "info");
            return ;
        }
    }

    //获得单选框的属性
    function gel(id) {
        return document.getElementById(id);
    }

    function btnAduitPass() {
        verify(true);
    }

    function btnAduitDeny() {
        verify(false);
    }

    //审核--确认
    function verify(status) {
        var receiveAccountRole = $("#searchReceiveAccountRoleAudit").combobox('getValue').trim();   //扣款人角色
        var accountId = $("#searchAccountIdAudit").val().trim();                                    //扣款人账户ID
        var accountNo = $("#searchAccountNoAudit").val().trim();                                    //扣款人账户编号
        var withHoldAmountAudit = $("#withHoldAmountAudit").val().trim();                             //扣款账户余额
        var amountAudit = $('#amountAudit').val().trim();                                           //扣账金额
        var transferType = $('input:radio[name="transferType"]:checked').val().trim();              //扣费方式
        var incomeTypeAudit = $('#incomeTypeAudit').combobox('getValue').trim();                    //入账账户
        var groupTypeAudit = $('#groupTypeAudit').combobox('getValue').trim();                      //费用所属部门
        var applyRemark = $("#applyRemark").val().trim();                                           //申请备注
        var auditRemark = $("#aduitRemark").val().trim();                                           //审核备注
        var row = $('#dg').datagrid('getSelected');
        var bizStatus = row.bizStatus;
        var platformChargeRecordId = row.platformChargeRecordId;
        var applyUserId = row.applyUserId;
        var chargeType = row.chargeType;

        //数据校验
        if(receiveAccountRole == null || receiveAccountRole ==""){
            $.messager.alert("提示", "收款角色不能为空,订单错误", "info");
            return;
        }else if(accountId == null || accountId ==""){
            $.messager.alert("提示", "收款账户ID不能为空,订单错误", "info");
            return;
        }else if(accountNo == null || accountNo ==""){
            $.messager.alert("提示", "收款账户编号不能为空,订单错误", "info");
            return;
        }else if(amountAudit == null || amountAudit == ""){
            $.messager.alert("提示", "转账金额不能为空,订单错误", "info");
            return;
        }else if(parseFloat(amountAudit) <= 0){
            $.messager.alert("提示", "转账金额必须大于0,请重新填写", "info");
            return;
        }else if(transferType == null || transferType == ""){
            $.messager.alert("提示", "转账类型不能为空,订单错误", "info");
            return;
        }else if(groupTypeAudit == null || groupTypeAudit ==""){
            $.messager.alert("提示", "费用所属部门不能为空,订单错误", "info");
            return;
        }else if(applyRemark == null || applyRemark ==""){
            $.messager.alert("提示", "申请备注不能为空,订单错误", "info");
            return;
        }else if(auditRemark == null || auditRemark ==""){
            $.messager.alert("提示", "审核备注不能为空,请填写完整", "info");
            return;
        }else if(auditRemark.length > 50){
            $.messager.alert("提示", "审核备注不能超过50个字,请重新填写完整", "info");
            return;
        }else if(platformChargeRecordId == null || platformChargeRecordId == ""){
            $.messager.alert("提示", "平台营销转账订单ID不能为空，订单错误", "info");
            return ;
        }else if(applyUserId == null || applyUserId == ""){
            $.messager.alert("提示", "转账申请人ID不能为空，订单错误", "info");
            return ;
        }else if(status && parseFloat(amountAudit) > parseFloat(withHoldAmountAudit)){
            $.messager.alert("提示", "扣款金额不能大于扣款账户余额,审核无法通过", "info");
            return;
        }
        //提交参数
        $.post("platformChargeRecordAudit.htm", {
            platformChargeRecordId : platformChargeRecordId,
            auditRemark : auditRemark,
            status : status,
            bizStatus : bizStatus,
            chargeType : chargeType,
            applyUserId : applyUserId
        }, function (data) {
            if (data.status) {
                var message = "审核成功";
                if(data.message != null){
                    message = data.message;
                }
                $.messager.alert("信息", message, "info", function () {
                    $('#dgMarketTransRecordAudit').dialog("close");
                    datagridBind();
                });
            } else {
                var message = "审核失败";
                if (data.message != null) {
                    message = data.message;
                }
                $.messager.alert("信息", message, "error", function () {
                    $('#dgMarketTransRecordAudit').dialog("close");
                    datagridBind();
                });
            }
        }, "json");
    }

    //获取验密地址
    function btnGetPwdAdress() {
        var row = $('#dg').datagrid('getSelected');
        var platformChargeRecordId = $("#platformChargeRecordId").val();
        $.post("getPlatformChargeRecordPwdAdress.htm", {
            platformChargeRecordId : platformChargeRecordId
        }, function (pager) {
            if(pager != null && pager != ''){
                $("#checkPwdAddress").textbox('setValue', pager.depositoryAddr);
            }else{
                $.messager.alert("提示", "获取验密地址失败", "info");
                $('#dlgPlatformPwdAddressDetail').dialog("close").window("center");
                return ;
            }
        }, "json");
    }

    //获取验密地址
    function btnGetPwdArdess() {
        //将单选框的按钮失效
        $('#searchReceiveAccountRole').combobox('disable');
        gel("verificationCodeVerification").disabled = true;
        gel("unVerificationCodeVerification").disabled = true;
        $('#groupTypeVerification').combobox('disable');
        $('#incomeType').combobox('disable');
        //首先在打开弹窗时进行弹窗中信息的初始化
        $("#searchReceiveAccountRole").combobox('setValue', "");
        $("#searchAccountId").textbox('setValue', "");
        $("#searchAccountNo").textbox('setValue', "");
        $("#amountAudit").textbox('setValue', "");
        // $("#platformAccountId").combobox('setValue', "");
        $("#applyRemark").textbox('setValue', "");
        // 获取单行的值，进行数据回显
        var row = $('#dg').datagrid('getSelected');
        $("#withHoldAmount").textbox('setValue', "");
        $("#amountSum").textbox('setValue', "");
        $("#incomeType").combobox('setValue', "");
        $("#withHoldRemark").textbox('setValue', "");
        $("#groupTypeVerification").combobox('setValue', "");
        $("#applyRemarkVerification").textbox('setValue', "");
        $("#aduitRemarkVerification").textbox('setValue', "");
        $("#checkPwdAddress").textbox('setValue', "");
        $("#checkPwdAddress").textbox('setValue', "");
        //与宋杰确认从账户的其他应付款-可用余额查询扣款账户余额
        var isNotHave = false;
        if(row != null){
            $("#searchReceiveAccountRole").combobox('setValue', row.chargeAccountRole);
            $("#searchAccountId").textbox('setValue', row.chargeAccountId);
            $("#searchAccountNo").textbox('setValue', row.chargeAccountNo);
            //扣款账户ID
            var chargeAccountId = row.chargeAccountId;
            //扣费方式
            var chargeType = row.chargeType;
            if(chargeType == "200"){
                $.messager.alert("提示", "扣费方式为免密扣费，无验密地址", "info");
                return;
            }
            var bizStatus = row.bizStatus;
            if(bizStatus == "100" || bizStatus == "150"){
                $.messager.alert("提示", "待审核状态和审核不通过状态，无验密地址", "info");
                return;
            }
            $.get("financeList.htm", {searchAccountId:chargeAccountId}, function(pager){
                if(pager.pageData != null && pager.pageData != ''){
                    for(var i = 0; i < pager.pageData.length; i++) {
                        if (pager.pageData[i].subjectId == "224101") {
                            isNotHave = true;
                            $("#withHoldAmount").textbox('setValue', decimalFormat(pager.pageData[i].balanceUse));
                            $("#amountSum").textbox('setValue', row.amount);
                            $("#incomeType").combobox('setValue', row.platformAccountRole);
                            $("#withHoldRemark").textbox('setValue', row.showContent);
                            $("#groupTypeVerification").combobox('setValue', row.groupType);
                            $("#applyRemarkVerification").textbox('setValue', row.applyContent);
                            $("#aduitRemarkVerification").textbox('setValue', row.aduitContent);
                            $("#checkPwdAddress").textbox('setValue', row.depositoryAddr);
                            $("#checkPwdAddress").textbox('setValue', row.depositoryAddr);
                            var chargeAccountType = row.chargeAccountType;
                            var chargeAccountRole = row.chargeAccountRole;
                            if (chargeAccountRole == "300") {
                                var searchReceiveAccountRole = chargeAccountType + "," + chargeAccountRole;
                                $("#searchReceiveAccountRole").combobox('setValue', searchReceiveAccountRole);
                            } else if(chargeAccountRole == "200") {
                                var searchReceiveAccountRole = chargeAccountType + "," + chargeAccountRole;
                                $("#searchReceiveAccountRole").combobox('setValue', searchReceiveAccountRole);
                            } else{
                                var searchReceiveAccountRole = chargeAccountRole;
                                $("#searchReceiveAccountRole").combobox('setValue', searchReceiveAccountRole);
                            }
                            //打开审核弹窗设置单选选中内容
                            if (chargeType == "100") {
                                gel("verificationCodeVerification").checked = true;
                            } else if (chargeType == "200") {
                                gel("unVerificationCodeVerification").checked = true;
                            } else {
                                $.messager.alert("提示", "操作错误,请重新操作！", "info");
                                return;
                            }
                            $('#dlgPlatformPwdAddressDetail').dialog("open").window("center");
                        }
                    }
                }

            },"json");
            if(isNotHave){
                $.messager.alert("提示", "改账户不存在其他应付款-可用余额子账户", "info");
                return ;
            }
        }else{
            $.messager.alert("提示", "请选择需要操作的项目！", "info");
            return ;
        }
    }


    //扣款账户角色
    function showChargeAccountRole(value,row) {
        if(value == 100){
            return "平台账户";
        }else if(value == 200){
            if(row.chargeAccountType ==200){
                return "个人投资人";
            }else if(row.chargeAccountType ==300){
                return "企业投资人";
            }
        }else if(value == 300){
            if(row.chargeAccountType ==200){
                return "个人借款人";
            }else if(row.chargeAccountType ==300){
                return "企业借款人";
            }
        }else if(value ==400){
            return "担保户";
        }else if(value ==500){
            return "商户";
        }
        return value;
    }

    //扣费方式
    function showChargeType(value) {
        if(value==100){
            return "验密扣费";
        }else if(value ==200){
            return "免密扣费";
        }else {
            return value;
        }
    }

    //转账类型
    function showTransferType(value) {
        if(value ==100){
            return "红包";
        }else if(value ==200){
            return "贴息";
        }
        return value;
    }

    function showGruopType(value) {
        if(value == 100){
            return "市场部";
        }else if(value == 110){
            return "运营部";
        }else if(value == 120){
            return "战略合作部";
        }else if(value ==130){
            return "其他";
        }
        return value;
    }

    //显示状态
    function showBizStatus(value) {
        if(value == 100){
            return "待审核";
        }else if(value== 150){
            return "审核拒绝";
        }else if(value==200){
            return "审核通过";
        }else if(value== 250){
            return "已调用存管";
        }else if(value== 300){
            return "存管调用失败";
        }else if(value== 350){
            return "存管处理中";
        }else if(value== 400){
            return "存管处理失败";
        }else if(value== 450){
            return "存管处理成功";
        }else if(value== 500){
            return "创建内账订单";
        }else if(value== 550){
            return "创建内账订单失败"
        }else if(value== 600){
            return "创建内账订单成功";
        }else if(value== 650){
            return "完成内账订单";
        }else if(value== 700){
            return "完成内账订单失败";
        }else if(value== 750){
            return "完成内账订单成功";
        }
        return value;
    }

    function timeStamp2DateTime(timeStamp) {
        timeStamp = parseInt(timeStamp);
        if (timeStamp > 0) {
            var datetime = new Date(timeStamp);
            return dateTimeFormat(datetime);
        } else {
            return "";
        }
    }
    function dateTimeFormat(date) {
        var month = date.getMonth() + 1;
        if (month < 10) {
            month = "0" + month;
        }
        var day = date.getDate();
        if (day < 10) {
            day = "0" + day;
        }
        var hour = date.getHours();
        if (hour < 10) {
            hour = "0" + hour;
        }
        var minutes = date.getMinutes();
        if (minutes < 10) {
            minutes = "0" + minutes;
        }
        var second = date.getSeconds();
        if (second < 10) {
            second = "0" + second;
        }
        var datetime = date.getFullYear() + "-" + month + "-" + day + " " + hour + ":" + minutes + ":" + second;
        return datetime;
    }

    function decimalFormat(number) {
        if (number == null) {
            return 0.00;
        } else {
            var num = new Number(number);
            return num.toFixed(2);
        }
    }

</script>
